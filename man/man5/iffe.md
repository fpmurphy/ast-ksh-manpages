# NAME

iffe - syntax of an iffe(1) statement.

# DESCRIPTION

`iffe(1)` is C compilation environment feature probe input consists of a sequence of statement lines.

`iffe(5)` describes the syntax of such statements.

Statements that span more than one line contain `begin``{` as the last operand (where `begin` is command specific) and zero or
more data lines terminated by a line containing `}end` as the first operand.

The statement syntax is:

    [name =] [!] test[,test...] [-] [arg[, arg...]] [prereq ...] [begin{ ... |end ...] [= [default]]

-   `test`s and `arg`s may be combined, separated by commas, to perform a set of tests on a set of arguments.

-   `name =` before `test` overrides the default test variable and macro name.

-   `-` after `test` performs the test but does not define the test variable and macro values.

-   `!` before `test` inverts the test sense for `if`, `elif`, and `yes{` and `no{` blocks.

-   `prereq`s are used when applying the features tests and may be combinations of:

    -   *compiler options*: `-D`, `-L`, etc.

    -   *library references*: `-l`, `.a`, etc.

        `_LIB_name` is defined to be 1 if `-lname` is a library.

    -   *header references*:   `.h`

        `_dir_name` is defined to be 1 if `dir/name.h` is a header, or if `dir` is omitted, `_hdr_name` is defined to be 1 if
        `name``.h` is a header.

-   `-` prereq grouping mark

    Prereqs before the first `-` are passed to all feature tests. Subsequent groups are attempted in left-to-right order until the
    first successful group is found.

-   `begin{` ... `}end` delimit multi-line code blocks that override or augment the default code provided by `iffe`. User supplied
    code blocks should be compatible with the K&R, ANSI, and C++ C language dialects for maximal portability. In addition to all
    macro definitions generated by previous tests, all generated code contains the following at the top to hide dialect
    differences:

    ```{.c}
    #if defined(__STDC__) || defined(__cplusplus) || defined(c_plusplus)
    #define _STD_ 1
    #define _ARG_(x) x
    #define _VOID_ void
    #else
    #define _STD_ 0
    #define _ARG_(x) ()
    #define _VOID_ char
    #endif
    #if defined(__cplusplus)
    #define _BEGIN_EXTERNS_ extern "C" {
    #define _END_EXTERNS_ }
    #else
    #define _BEGIN_EXTERNS_
    #define _END_EXTERNS_
    #endif
    #define _NIL_(x) ((x)0)
    #include <stdio.h>
    ```

-   `= default` may be specified for the `key`, `lib`, `mac`, `mth` and `typ` tests.

    If the test fails for `arg` then `#define arg default` is emitted. `key` accepts multiple `= default` values; the first valid
    one is used.

Each test statement generates a portion of a C language header that contains macro defintions, comments, and other text
corresponding to the feature tests.

```{.c}
#ifndef _def_name_directory ... #endif
```

guards the generated header from multiple `#include`s, where:

-   `name` is determined by either the `run` statement input file name if any, or the first `test` in the first statement, and
-   `directory` is the basename component of either the `run` statement file, if any, or the current working directory.

The output file name is determined in this order:

1.  `-` -- If the first command line operand is `-` then the output is written to the standard output.

1.  `--output=file` -- Output is `file`.

1.  `set out file` -- Output is `file`.

1.  `[run] [directory/]base[.suffix]` -- Output is `FEATURE/base`.

Generated `iffe` headers are often referenced in C source as:

```{.c}
#include "FEATURE/file
```

The `nmake(1)` base rules contain meta-rules for generating `FEATURE/file` from `features/file[suffix]`, where `suffix` may be
omitted, `.c`, or `.sh` (see the `run` test below).

Because `#include` prerequisites are automatically detected, `nmake(1)` ensures that all prerequisite `iffe(1)` headers are
generated before compilation.

Note that the directories are deliberately named `FEATURE` and `features` to keep case-ignorant file systems happy.

# FEATURE TESTS

The feature tests are:

1.  `# comment`

    Comment line - ignored.

1.  `api name YYYYMMDD symbol ...`

    Emit API compatibility tests for `name` and

    ```{.c}
    #define symbol symbol_YYYYMMDD`
    ```

    when `NAME_API is >= YYYYMMDD` (`NAME` is `name` converted to upper case).

    If `NAME_API` is not defined then `symbol` maps to the newest `YYYYMMDD` for `name`.

1.  `define name [(arg,...)] [value]`

    Emit a macro `#define` for `name` if it is not already defined. The definition is passed to subsequent tests.

1.  `extern name type [ (arg,...) | [dimension] ]`

    Emit an `extern` prototype for `name` if one is not already defined. The prototype is passed to subsequent tests.

1.  `header header`

    Emit

    ```{.c}
    #include <header>
    ```

    if `header` exists. The `#include` is passed to subsequent tests.

1.  `print text`

    Copy `text` to the output file. `text` is passed to subsequent tests.

1.  `reference header`

    If `header` exists then add

    ```{.c}
    #include header
    ```

    to subsequent tests.

1.  `ver name YYYYMMDD`

    Emits:

    ```{.c}
    #define NAME_VERSION YYYYMMDD
    ```

    where `NAME` is `name` converted to upper case.

1.  `cmd name`

    Defines `_cmd_name` if `name` is an executable in one of the standard system directories (`/bin`, `/etc`, `/usr/bin`,
    `/usr/etc`, `/usr/ucb`).

    ```
    _directory_name
    ```

    is defined for `directory` in which `name` is found (with `/` translated to `_`).

1.  `dat name`

    Defines `_dat_name` if `name` is a data symbol in the default libraries.

1.  `def name`

    Equivalent to `cmd,dat,hdr,key,lib,mth,sys,typ name`.

1.  `dfn name`

    If `name` is a macro in the candidate headers then a

    ```{.c}
    #define name value
    ```

    statment is output for the `value` defined in the headers. The definition is `#ifndef` guarded.

1.  `exp name expression`

    If `expression` is a "..." string then `name` is defined to be the string, else if the `expr(1)` evaluation of `expression` is
    not 0 then `name` is defined to be 1, otherwise `name` is defined to be 0. Identifiers in `expression` may be previously
    defined names from other `iffe` tests; undefined names evaluate to 0.

    If `name` was defined in a previous successful test then the current and subsequent `exp` test on `name` are skipped.

    If `name` is `-` then the `expression` is simply evaluated.

1.  `hdr name`

    Defines `_hdr_name` if the header `<name.h>` exists. The `--config` macro name is `HAVE_NAME_H`.

1.  `if statement ... | elif statement ... | else | endif

    Nested if-else test control.

1.  `iff name`

    The generated header `#ifndef-#endif` macro guard is `_name_H`.

1.  `inc file [re]`

    Read `#define` macro names from `file` and arrange for those names to evaluate to 1 in `exp` expressions. If `re` is specified
    then macros not matching `re` are ignored.

1.  `key name`

    Defines `_key_name` if `name` is a reserved word (keyword).

1.  `lcl name`

    Generates a `#include` statement for the native version of the header `<name.h>` if it exists.

    Defines `_lcl_name` on success. The `--config` macro name is `HAVE_NAME_H`. The default `re` is `^HAVE\_` for `--config` and
    `^\_` otherwise.

1.  `lib name`

    Defines `_lib_``name` if `name` is an external symbol in the default libraries.

1.  `mac name`

    Defines `_mac_name` if `name` is a macro.

1.  `mem struct.member`

    Defines `_mem_member_struct` if `member` is a member of the structure `struct`.

1.  `mth name`

    Defines `_mth_name` if `name` is an external symbol in the math library.

1.  `nop name`

    If this is the first test then `name` may be used to name the output file and/or the output header guard macro.
    Otherwise this test is ignored.

1.  `npt name`

    Defines `_npt_name` if the `name` symbol requires a prototype.

    The `--config` macro name is `HAVE_NAME_DECL` with the opposite sense.

1.  `num name`

    Defines `_num_name` if `name` is a numeric constant `enum` or `macro`.

1.  `nxt name`

    Defines a string macro `_nxt_name` suitable for a `#include` statement to include the next (on the include path) or native
    version of the header `<name.h>` if it exists. Also defines the "..." form `_nxt_name_str`.

    The `--config` macro name is `HAVE_``NAME``_NEXT` .

1.  `one header ...`

    Generates a `#include` statement for the first header found in the `header` list.

1.  `opt name`

    Defines `_opt_name` if `name` is a space-separated token in the global environment variable `PACKAGE_OPTIONS`.

1.  `pth file [ dir ... | { g1 - ... - gn } | < pkg [ver ...] > ]`

    Defines `_pth_file`, with embedded `/` chars translated to `_`, to the path of the first instance of `file` in the `dir`
    directories.

    -   `{` ... `}` forms a directory list from the cross-product of `-` separated directory groups `g1` ... `gn`.
    -   `< ... >` forms a directory list for the package `pkg` with optional versions.

    If no operands are specified then the default PATH directories are used.

    The `--config` macro name is `NAME_PATH`.

1.  `run file`

    Runs the tests in `file` based on the `file` suffix:

    -   `.c`: `file` is compiled and executed and the output is copied to the `iffe` output file.

        Macros and headers supplied to `begin{` ... `}end` are also supplied to `file`.

    -   `.sh`: `file` is executed as a shell script and the output is copied to the `iffe` output file.

    -   `.iffe` or no suffix: `file` contains `iffe` statements.

1.  `set option value`

    Sets option values. The options are described above.

1.  `siz name`

    Defines `_siz_name` to be `sizeof(name) if `name` is a type in any of:

    -   `<sys/types.h>`,
    -   `<times.h>`,
    -   `<stddef.h>`,
    -   `<stdlib.h>`.

    Any `.` characters in `name` are translated to space before testing and are translated to `_` in the output macro name.

1.  `sym name`

    Defines `_ary_name` if `name` is an array, `_fun_name` if `name` is a function pointer, `_ptr_name` if `name` is a pointer, or
    `_reg_name` if `name` is a scalar.

    In most cases `name` is part of a macro expansion.

1.  `sys name`

    Defines `_sys_name` if the header `<sys/name.h>` exists.

    The `--config` macro name is `HAVE_SYS_NAME_H`.

1.  `tst name`

    A user defined test on name. A source block must be supplied.

    Defines `_name` on success.

    `tst - ...` is treated as `tst - - ...`.

1.  `typ name`

    Defines `_typ_name` if `name` is a type in any of:

    -   `<sys/types.h>`,
    -   `<times.h>`,
    -   `<stddef.h>`,
    -   `<stdlib.h>`.

    Any `.` characters in `name` are translated to space before testing and are translated to `_` in the output macro name.

1.  `val name`

    The output of `print name` is written to the output file.

1.  `var name`

    A user defined test on name. A source block must be supplied. Sets the `exp` variable `_name` on success but does not define a
    macro.

1.  `(expression)`

    Equivalent to `exp - expression`.


# CODE BLOCKS

Code block names may be prefixed by `no` to invert the test sense.

The block names are:

1.  `cat`

    The block is copied to the output file.

1.  `compile`

    The block is compiled (`cc -c`).

1.  `cross`

    The block is executed as a shell script using `crossexec(1)` if `--cross` is on, or on the local host otherwise, and the
    output is copied to the output file. Test macros are not exported to the script.

1.  `execute`

    The block is compiled, linked, and executed. `0` exit status means success.

1.  `fail`

    If the test fails then the block text is evaluated by `ksh(1)`

1.  `link`

    The block is compiled and linked (`cc -o`).

1.  `macro`

    The block is preprocessed (`cc -E`) and lines containing text bracketed by `<<"` ... `">>` (`less-than less-than double-quote
    ... double-quote greater-than greater-than`) are copied to the output file with the brackets omitted.

1.  `no`

    If the test fails then the block text is copied to the output file.

    Deprecated: use { `if` `elif` `else` `endif` } with unnamed `{` ... `}` blocks.

1.  `note`

    If the test succeeds then the block is copied to the output as a `/ ... /` comment.

1.  `output`

    The block is compiled, linked, and executed, and the output is copied to the output file.

1.  `pass`

    If the test succeeds then the block text is evaluated by `ksh(1)`

1.  `preprocess`

    The block is preprocessed (`cc -E`).

1.  `run`

    The block is executed as a shell script and the output is copied to the output file. Succesful test macros are also defined as
    shell variables with value `1` and are available within the block. Likewise, failed test macros are defined as shell variables
    with value `0`.

1.  `status`

    The block is compiled, linked, and executed, and the exit status is the test outcome, 0 for `failure`, the value otherwise.

1.  `yes`

    If the test succeeds then the block text is copied to the output file. `yes{` ... `}end` is equivalent to the unnamed block
    `{` ... `}`.

    Deprecated: use { `if` `elif` `else` `endif` } with unnamed `{` ... `}` blocks.

# SEE ALSO

`autoconf(1)`,
`config(1)`,
`crossexec(1)`,
`getconf(1)`,
`iffe(1)`,
`ksh(1)`,
`nmake(1)`,
`package(1)`,
`proto(1)`.

# IMPLEMENTATION

version
:   iffe (AT&T Research) 2012-06-08

author
:   Glenn Fowler
:   Phong Vo

copyright
:   Copyright © 1994-2012 AT&T Intellectual Property

license
:   <http://www.eclipse.org/org/documents/epl-v10.html>

